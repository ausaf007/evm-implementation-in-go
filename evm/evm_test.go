package evm

import (
	log "github.com/sirupsen/logrus"
	"reflect"
	"testing"
)

func TestRunByteCodeCase1(t *testing.T) {
	log.SetLevel(log.WarnLevel)

	input := "60016020526002606452600361ff0052600362ffffff526005601053"
	wantHash := "ab2744998886b708acadc0a32428d0aa1953e83924383d21c6de5dac852ccbcc"
	wantGas := 538445872

	gotHash, gotGas, err := RunByteCode(input)
	if err != nil {
		t.Errorf("Encountered Error:%s", err)
	}

	if (gotHash != wantHash) || (gotGas != wantGas) {
		t.Errorf("Expected hash='%q', but got '%q'\nExpected Gas= %d, but got %d", wantHash, gotHash, wantGas, gotGas)
	}
}

func TestRunByteCodeCase2(t *testing.T) {
	log.SetLevel(log.WarnLevel)

	input := "7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00016000527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00026020527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff05604052"
	wantHash := "b9a07dba38aa24923a611fced9d2eede3bfbfa281e5e498d60f4bd99e5ce6a15"
	wantGas := 58

	gotHash, gotGas, err := RunByteCode(input)
	if err != nil {
		t.Errorf("Encountered Error:%s", err)
	}

	if (gotHash != wantHash) || (gotGas != wantGas) {
		t.Errorf("Expected hash='%q', but got '%q'\nExpected Gas= %d, but got %d", wantHash, gotHash, wantGas, gotGas)
	}
}

func TestRunByteCodeCase3(t *testing.T) {
	log.SetLevel(log.WarnLevel)

	input := "7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000a6000527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000a6020527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0a604052"
	wantHash := "afe1e714d2cd3ed5b0fa0a04ee95cd564b955ab8661c5665588758b48b66e263"
	wantGas := 4875

	gotHash, gotGas, err := RunByteCode(input)
	if err != nil {
		t.Errorf("Encountered Error:%s", err)
	}

	if (gotHash != wantHash) || (gotGas != wantGas) {
		t.Errorf("Expected hash='%q', but got '%q'\nExpected Gas= %d, but got %d", wantHash, gotHash, wantGas, gotGas)
	}
}

func TestRunByteCodeCase4(t *testing.T) {
	log.SetLevel(log.WarnLevel)

	// Stack filled with 1024 elements exact
	input := "60f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f2"

	wantGas := 3072

	_, gotGas, err := RunByteCode(input)
	if err != nil {
		t.Errorf("Encountered Error:%s", err)
	}

	if gotGas != wantGas {
		t.Errorf("\nExpected Gas= %d, but got %d", wantGas, gotGas)
	}
}

func TestRunByteCodeCase5(t *testing.T) {
	log.SetLevel(log.WarnLevel)

	// Stack filled with 1025 elements exact
	input := "60f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f260f2"

	_, _, err := RunByteCode(input)

	if reflect.DeepEqual(err, StackMaxSizeReached) {
		// passed
	} else {
		t.Errorf("Stack Overflow Error not caught")
	}

}
